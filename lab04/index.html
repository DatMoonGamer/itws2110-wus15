<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Flight Briefing System</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Cockpit Aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Deep, professional cockpit blue/black */
            background: #0D1626; 
        }
        
        #app-container {
            min-height: 100vh;
        }

        /* Loading Spinner Animation (Amber accent for instrument lighting) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1); 
            border-top: 4px solid #fbbf24; /* Amber */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom styling for the METAR iframe container */
        #metar-iframe-container {
            /* Ensures the iframe is responsive and fits the card */
            width: 100%;
            height: 250px; /* Fixed height to prevent layout shift */
            background-color: #1f2937; /* Dark gray fallback */
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #374151;
        }
    </style>
</head>
<body class="text-white">

    <div id="app-container" class="p-6 flex flex-col items-center justify-center">
        
        <!-- Header with Plane Image (SVG inline for self-contained file) -->
        <div class="flex flex-col items-center mb-6">
            <!-- A Simple, stylish SVG icon of a jet plane -->
            <svg class="w-16 h-16 text-blue-400 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17.84 9.17l-7.23-7.22a.5.5 0 00-.71 0L2.68 9.17a.5.5 0 00.35.85H5.5V17a1 1 0 001 1h10a1 1 0 001-1v-7h2.47a.5.5 0 00.34-.83zM12 17v-8m0 0l-3 4m3-4l3 4"/>
                <path d="M12 18v2.5M9.5 20.5H14.5"/>
            </svg>
            <h1 class="text-4xl font-extrabold text-center text-amber-400">
                <span class="text-blue-400">EFB</span> - Pilot Flight Briefing
            </h1>
        </div>
        
        <p class="text-gray-400 mb-8 text-lg text-center max-w-xl">
            Flight Conditions (WX), Official METAR, and Pilot's Briefing
        </p>

        <!-- Main Content Area (3 Panels in a 2x2 grid) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-6xl">

            <!-- 1. OpenWeatherMap Card (Flight Conditions) -->
            <div id="weather-card" class="bg-blue-900/40 p-6 rounded-xl shadow-xl transition duration-300 hover:shadow-amber-500/30 border border-blue-700/50 md:col-span-1">
                <h2 class="text-2xl font-bold mb-4 border-b border-blue-700 pb-2 flex items-center text-blue-300">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="color:#fbbf24;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    Flight Conditions (WX) for <span id="weather-location" class="ml-1 text-amber-400">Troy, US</span>
                </h2>
                <div id="weather-data-content" class="flex flex-col space-y-3">
                    <div class="spinner mx-auto" id="weather-spinner"></div>
                    <p class="text-gray-400 text-center">Awaiting WX report...</p>
                </div>
            </div>

            <!-- 2. Official METAR Widget (METAR-TAF.com Embed) -->
            <div id="metar-card" class="bg-blue-900/40 p-6 rounded-xl shadow-xl transition duration-300 hover:shadow-amber-500/30 border border-blue-700/50 md:col-span-1">
                <h2 class="text-2xl font-bold mb-4 border-b border-blue-700 pb-2 flex items-center text-blue-300">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="color:#fbbf24;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Official METAR for <span class="ml-1 text-amber-400">KALB</span>
                </h2>
                <div id="metar-iframe-container">
                    <!-- Embed METAR-TAF.com Iframe for KALB -->
                    <iframe 
                        src="https://metar-taf.com/embed/kalb" 
                        title="METAR for KALB" 
                        width="100%" 
                        height="100%" 
                        style="border: none; background-color: transparent;"
                        loading="lazy">
                    </iframe>
                </div>
                <p class="text-gray-500 text-xs mt-3">
                    METAR data provided by metar-taf.com.
                </p>
            </div>
            
            <!-- 3. ZenQuotes Card (Pilot's Briefing) - Spans both columns on small screens, full width on medium screens -->
            <div id="second-api-card" class="bg-blue-900/40 p-6 rounded-xl shadow-xl transition duration-300 hover:shadow-amber-500/30 border border-blue-700/50 md:col-span-2">
                <h2 class="text-2xl font-bold mb-4 border-b border-blue-700 pb-2 flex items-center text-blue-300">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="color:#fbbf24;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h10m-5 4h5M9 6v.586a2 2 0 01.586 1.414L7.414 10.414a2 2 0 00-.586 1.414V14a2 2 0 002 2h6a2 2 0 002-2v-2.172a2 2 0 00-.586-1.414L14.586 7.586A2 2 0 0115 6.586V6"></path></svg>
                    Pilot's Briefing (ZenQuotes)
                </h2>
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div id="second-api-data-content" class="flex-grow w-full md:w-auto">
                        <div class="spinner mx-auto"></div>
                        <p class="text-gray-400 text-center mt-2">Loading inspiration...</p>
                    </div>
                    <!-- Refresh Button (Amber/Blue color scheme) -->
                    <button id="refresh-quote-btn" class="shrink-0 w-full md:w-auto bg-amber-600 hover:bg-amber-700 text-gray-900 font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-50">
                        New Briefing
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Geolocation Button (Indigo/Blue color scheme) -->
        <button id="geolocation-btn" class="mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-xl hover:shadow-indigo-400/50 text-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-75">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.727A8 8 0 016.343 5.273L4.363 7.253a1 1 0 00-.07 1.414l.707.707A1 1 0 005.657 9.879l1.414-1.414M16.95 14.243l-1.414 1.414a1 1 0 00-.707.07l-1.414.707M12 12V3a1 1 0 00-2 0v9a1 1 0 002 0zM7 16a5 5 0 1110 0 5 5 0 01-10 0z"></path></svg>
            Set Current Position (WX Update Only)
        </button>

        <!-- Message Box -->
        <div id="message-box" class="mt-4 p-3 max-w-lg w-full text-center text-sm rounded-lg bg-blue-800 text-sky-300 border border-sky-600 hidden">
            <!-- Messages will appear here -->
        </div>

    </div>

    <!-- JavaScript/AJAX/JSON Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS AND CONFIGURATION ---
            const OPEN_WEATHER_API_KEY = "c24e364f8679bc72ef1e962dd5ece75d"; 
            const OPEN_WEATHER_BASE_URL = "https://api.openweathermap.org/data/2.5/weather";
            
            // CORS Proxy Base URL - REQUIRED for OpenWeatherMap and ZenQuotes
            const CORS_PROXY_BASE = "https://corsproxy.io/?";

            // SECOND API: ZenQuotes API
            const ZENQUOTES_API_URL = `${CORS_PROXY_BASE}https://zenquotes.io/api/random`; 
            
            // Default location for the assignment
            const DEFAULT_CITY = "Troy, US"; 

            // DOM Elements
            const weatherContent = document.getElementById('weather-data-content');
            const secondApiContent = document.getElementById('second-api-data-content');
            const weatherLocationSpan = document.getElementById('weather-location');
            const geolocationBtn = document.getElementById('geolocation-btn');
            const refreshQuoteBtn = document.getElementById('refresh-quote-btn'); 
            const messageBox = document.getElementById('message-box');
            
            // --- UTILITY FUNCTIONS ---
            
            function showMessage(text, type = 'info') {
                messageBox.textContent = text;
                messageBox.className = 'mt-4 p-3 max-w-lg w-full text-center text-sm rounded-lg';
                messageBox.classList.remove('hidden');

                if (type === 'error') {
                    messageBox.classList.add('bg-red-900/50', 'text-amber-400', 'border', 'border-red-800');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-blue-900', 'text-blue-300', 'border', 'border-blue-600');
                } else { // info/default
                    messageBox.classList.add('bg-blue-800', 'text-sky-300', 'border', 'border-sky-600');
                }
                setTimeout(() => messageBox.classList.add('hidden'), 5000);
            }

            function kelvinToCelsius(k) {
                return (k - 273.15).toFixed(1);
            }

            // --- WX API LOGIC ---

            async function fetchWeatherData(params) {
                const originalUrlParams = new URLSearchParams({
                    appid: OPEN_WEATHER_API_KEY, 
                    ...params
                });
                const originalUrl = `${OPEN_WEATHER_BASE_URL}?${originalUrlParams.toString()}`;
                const proxiedUrl = `${CORS_PROXY_BASE}${originalUrl}`;

                weatherContent.innerHTML = '<div class="spinner mx-auto"></div><p class="text-gray-400 text-center mt-2">Awaiting WX report...</p>';

                try {
                    const response = await fetch(proxiedUrl);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Unknown API error' }));
                        let errorMessage = errorData.message || 'Server did not return weather data.';
                        if (response.status === 401 && OPEN_WEATHER_API_KEY === "YOUR_OPENWEATHERMAP_API_KEY") {
                            errorMessage = "API Key Missing! Please replace 'YOUR_OPENWEATHERMAP_API_KEY' with your actual key.";
                        }
                        throw new Error(`Status ${response.status}: ${errorMessage}`);
                    }
                    
                    const data = await response.json();
                    updateWeatherUI(data);

                } catch (error) {
                    console.error("Error fetching WX data:", error);
                    weatherContent.innerHTML = `<p class="text-red-400 text-center">WX Failed: ${error.message}</p>`;
                }
            }

            function updateWeatherUI(data) {
                const tempC = kelvinToCelsius(data.main.temp);
                const description = data.weather[0].description;
                const windSpeed = data.wind.speed.toFixed(1);
                const humidity = data.main.humidity;
                const clouds = data.clouds.all;
                const location = `${data.name}, ${data.sys.country}`;
                const iconCode = data.weather[0].icon;
                const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;

                weatherLocationSpan.textContent = location;

                // Pilot terminology and high-contrast styling
                weatherContent.innerHTML = `
                    <div class="flex items-center justify-between">
                        <!-- Temperature and Icon -->
                        <div class="flex items-center">
                            <img src="${iconUrl}" onerror="this.onerror=null; this.src='https://placehold.co/80x80/1e3a8a/e0f2f1?text=WX+ICON'" alt="${description}" class="w-20 h-20 filter drop-shadow-lg">
                            <p class="text-6xl font-light ml-2 text-white">${tempC}<span class="text-3xl align-top text-blue-300">°C</span></p>
                        </div>
                        <!-- Details -->
                        <div class="text-right space-y-2 text-gray-300">
                            <p class="text-xl font-medium capitalize text-blue-400">${description}</p>
                            <div class="flex justify-end items-center text-sm">
                                <span class="mr-2 text-amber-300">Surface Wind:</span>
                                <span class="font-semibold">${windSpeed}</span> m/s
                            </div>
                            <div class="flex justify-end items-center text-sm">
                                <span class="mr-2 text-amber-300">Humidity:</span>
                                <span class="font-semibold">${humidity}</span>%
                            </div>
                            <div class="flex justify-end items-center text-sm">
                                <span class="mr-2 text-amber-300">Cloud Cover:</span>
                                <span class="font-semibold">${clouds}</span>%
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- METAR LOGIC (Removed old fetch logic, relying on Iframe now) ---
            
            // --- SECOND API LOGIC (Pilot's Briefing) ---
            
            async function fetchSecondAPIData() {
                refreshQuoteBtn.disabled = true;
                secondApiContent.innerHTML = '<div class="spinner mx-auto"></div><p class="text-gray-400 text-center mt-2">Loading inspiration...</p>';
                
                try {
                    const response = await fetch(ZENQUOTES_API_URL);
                    if (!response.ok) {
                         throw new Error(`ZenQuotes API (via proxy) returned status ${response.status}.`);
                    }
                    
                    const data = await response.json(); 
                    if (!Array.isArray(data) || data.length === 0) {
                        throw new Error("API returned an empty or unexpected response.");
                    }
                    
                    updateSecondAPIUI(data[0]);

                    refreshQuoteBtn.classList.remove('bg-amber-600');
                    refreshQuoteBtn.classList.add('bg-blue-600', 'ring-4', 'ring-blue-500');
                    setTimeout(() => {
                        refreshQuoteBtn.classList.remove('bg-blue-600', 'ring-4', 'ring-blue-500');
                        refreshQuoteBtn.classList.add('bg-amber-600');
                        refreshQuoteBtn.disabled = false;
                    }, 500);

                } catch (error) {
                    console.error("Error fetching ZenQuotes API data:", error);
                    secondApiContent.innerHTML = `<p class="text-red-400 text-center">Briefing Failed: ${error.message}.</p>`;
                    refreshQuoteBtn.disabled = false;
                }
            }

            function updateSecondAPIUI(data) {
                const quoteContent = data.q || "Success is not final, failure is not fatal: it is the courage to continue that counts.";
                const quoteAuthor = data.a || "Winston Churchill";
                
                secondApiContent.innerHTML = `
                    <div class="text-left p-4 bg-blue-800 rounded-lg border-l-4 border-amber-400">
                        <blockquote class="text-xl italic mb-3 text-white">
                            "${quoteContent}"
                        </blockquote>
                        <p class="text-right font-semibold text-amber-400">
                            — ${quoteAuthor}
                        </p>
                    </div>
                `;
            }


            // --- GEOLOCATION BONUS LOGIC ---

            function handleGeolocation() {
                geolocationBtn.disabled = true;
                geolocationBtn.textContent = 'Acquiring Position...';
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            
                            showMessage(`Position Acquired! Lat: ${lat.toFixed(3)}, Lon: ${lon.toFixed(3)}. Fetching local WX...`, 'success');
                            
                            // Call weather API using coordinates
                            fetchWeatherData({ lat: lat, lon: lon });

                            geolocationBtn.textContent = 'Position Set (WX Updated)';
                        },
                        (error) => {
                            let msg = "Position acquisition failed. Reverting to Troy WX.";
                            if (error.code === error.PERMISSION_DENIED) {
                                msg = "Permission denied for location access. Please enable GPS in your browser.";
                            }
                            showMessage(`WARNING: ${msg}`, 'error');
                            console.error("Geolocation Error:", error.message);
                            
                            fetchWeatherData({ q: DEFAULT_CITY });
                            
                            geolocationBtn.disabled = false;
                            geolocationBtn.textContent = 'Set Current Position (WX Update Only)';
                        }
                    );
                } else {
                    showMessage("Geolocation not available in this EFB. Defaulting to Troy WX.", 'error');
                    fetchWeatherData({ q: DEFAULT_CITY });
                    geolocationBtn.disabled = true;
                    geolocationBtn.textContent = 'Position Feature Unavailable';
                }
            }


            // --- INITIALIZATION & EVENT LISTENERS ---

            // Initial data fetch (Troy, US requirement)
            fetchWeatherData({ q: DEFAULT_CITY });
            // METAR fetch is no longer needed as we use the iframe embed.
            fetchSecondAPIData(); 

            // Event Listener for Geolocation Button (Bonus)
            geolocationBtn.addEventListener('click', handleGeolocation);

            // Event Listener for Second API Refresh Button
            refreshQuoteBtn.addEventListener('click', fetchSecondAPIData);

        });
    </script>

</body>
</html>
